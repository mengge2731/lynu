<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wanhong.dao.UserInfoDao">

	<!-- user_info 所有查询列 -->
	<sql id="QUERY_COLUMN_LIST">
		<![CDATA[
			user_id AS userId
			,user_name AS userName
			,phone AS phone
			,introduction AS introduction
			,user_type AS user_type
			,status AS status
			,created AS created
			,modified AS modified
			,relation AS relation

			,height AS height
			,weight AS weight
			,allergy_sku AS allergySku
			,allergy_sku_other AS allergySkuOther
			,allergy_food AS allergyFood
			,allergy_food_other AS allergyFoodOther
			,family_ill_history AS familyIllHistory
			,family_ill_history_other AS familyIllHistoryOther
			,own_ill_history AS ownIllHistory
			,own_ill_history_other AS ownIllHistoryOther
			,habit AS habit
			,habit_other AS habitOther
			,channel AS channel
			,outside_id AS outsideId

			,right_myopia AS rightMyopia
			,left_myopia AS leftMyopia
			,is_astigmatic AS isAstigmatic
			,right_astigmatic AS rightAstigmatic
			,left_astigmatic AS leftAstigmatic
			,right_axle_position AS rightAxlePosition
			,left_axle_position AS leftAxlePosition
			,id_card_num AS idCardNum
			,patient_id AS patientId
			,verify_status AS verifyStatus

		]]>
	</sql>

	<!-- patient_info 所有查询列 -->
	<sql id="QUERY_SIMPLE_COLUMN_LIST">
		<![CDATA[
			patient_name AS patientName
			,phone AS phone
			,id_card_num AS idCardNum
		]]>
	</sql>



	<!--根据userpin查询患者-->
	<select id="getPatientInfoList" parameterType="java.lang.String" resultType="patientInfo">
		SELECT
			<include refid="QUERY_COLUMN_LIST"/>
        FROM
			patient_info t
		WHERE
			user_pin = #{userPin}
		AND
		    status = 1
		ORDER BY t.created ASC
		LIMIT 0,20
	</select>

	<!--保存患者信息-->
	<insert id="savePatientInfo" parameterType="patientInfo" useGeneratedKeys="true" keyProperty="id">
		INSERT IGNORE INTO patient_info
		(
		patient_id
		,patient_name
		,sex
		,phone
		,user_pin
		,birthday
		,status
		,created
		,modified
		<if test="relation != null and relation != ''">,relation</if>
		<if test="height != null and height != ''">,height</if>
		<if test="weight != null and weight != ''">,weight</if>
		<if test="allergySku != null and allergySku != ''">,allergy_sku</if>
		<if test="allergySkuOther != null and allergySkuOther != ''">,allergy_sku_other</if>
		<if test="allergyFood != null and allergyFood != ''">,allergy_food</if>
		<if test="allergyFoodOther != null and allergyFoodOther != ''">,allergy_food_other</if>
		<if test="familyIllHistory != null and familyIllHistory != ''">,family_ill_history</if>
		<if test="familyIllHistoryOther != null and familyIllHistoryOther != ''">,family_ill_history_other</if>
		<if test="ownIllHistory != null and ownIllHistory != ''">,own_ill_history</if>
		<if test="ownIllHistoryOther != null and ownIllHistoryOther != ''">,own_ill_history_other</if>
		<if test="habit != null and habit != ''">,habit</if>
		<if test="habitOther != null and habitOther != ''">,habit_other</if>
		<if test="channel != null and channel != ''">,channel</if>
		<if test="outsideId != null and outsideId != ''">,outside_id</if>
		<if test="idCardNum != null and idCardNum != ''">,id_card_num</if>
		<if test="idCardNum != null and idCardNum != ''">,verify_status</if>
		)
		VALUES
		(
		#{patientId}
		,#{patientName}
		,#{sex}
		,#{phone}
		,#{userPin}
		,#{birthday}
		,1
		,now()
		,now()
		<if test="relation != null and relation != ''">,#{relation}</if>
		<if test="height != null and height != ''">,#{height}</if>
		<if test="weight != null and weight != ''">,#{weight}</if>
		<if test="allergySku != null and allergySku != ''">,#{allergySku}</if>
		<if test="allergySkuOther != null and allergySkuOther != ''">,#{allergySkuOther}</if>
		<if test="allergyFood != null and allergyFood != ''">,#{allergyFood}</if>
		<if test="allergyFoodOther != null and allergyFoodOther != ''">,#{allergyFoodOther}</if>
		<if test="familyIllHistory != null and familyIllHistory != ''">,#{familyIllHistory}</if>
		<if test="familyIllHistoryOther != null and familyIllHistoryOther != ''">,#{familyIllHistoryOther}</if>
		<if test="ownIllHistory != null and ownIllHistory != ''">,#{ownIllHistory}</if>
		<if test="ownIllHistoryOther != null and ownIllHistoryOther != ''">,#{ownIllHistoryOther}</if>
		<if test="habit != null and habit != ''">,#{habit}</if>
		<if test="habitOther != null and habitOther != ''">,#{habitOther}</if>
		<if test="channel != null and channel != ''">,#{channel}</if>
		<if test="outsideId != null and outsideId != ''">,#{outsideId}</if>
		<if test="idCardNum != null and idCardNum != ''">,#{idCardNum}</if>
		<if test="idCardNum != null and idCardNum != ''">,2</if>
		)
	</insert>
<!--更新患者信息-->
	<update id="updatePatientInfo" parameterType="patientInfo">
		UPDATE
			patient_info
		SET
			modified=NOW()
		<if test="patientName!=null" >, patient_name=#{patientName}</if>
		<if test="sex!=null " >, sex=#{sex}</if>
		<if test="phone!=null " >, phone=#{phone}</if>
		<if test="birthday!=null" >, birthday=#{birthday}</if>
		<choose>
			<when test="height != ''"><![CDATA[,height=#{height}]]></when>
			<otherwise><![CDATA[,height=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="weight != ''"><![CDATA[,weight=#{weight}]]></when>
			<otherwise><![CDATA[,weight=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="allergySku!=null and allergySku != ''"><![CDATA[,allergy_sku=#{allergySku}]]></when>
			<otherwise><![CDATA[,allergy_sku=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="allergySkuOther!=null and allergySkuOther != ''"><![CDATA[,allergy_sku_other=#{allergySkuOther}]]></when>
			<otherwise><![CDATA[,allergy_sku_other=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="allergyFood!=null and allergyFood != ''"><![CDATA[,allergy_food=#{allergyFood}]]></when>
			<otherwise><![CDATA[,allergy_food=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="allergyFoodOther!=null and allergyFoodOther != ''"><![CDATA[,allergy_food_other=#{allergyFoodOther}]]></when>
			<otherwise><![CDATA[,allergy_food_other=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="familyIllHistory!=null and familyIllHistory != ''"><![CDATA[,family_ill_history=#{familyIllHistory}]]></when>
			<otherwise><![CDATA[,family_ill_history=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="familyIllHistoryOther!=null and familyIllHistoryOther != ''"><![CDATA[,family_ill_history_other=#{familyIllHistoryOther}]]></when>
			<otherwise><![CDATA[,family_ill_history_other=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="ownIllHistory!=null and ownIllHistory != ''"><![CDATA[,own_ill_history=#{ownIllHistory}]]></when>
			<otherwise><![CDATA[,own_ill_history=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="ownIllHistoryOther!=null and ownIllHistoryOther != ''"><![CDATA[,own_ill_history_other=#{ownIllHistoryOther}]]></when>
			<otherwise><![CDATA[,own_ill_history_other=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="habit!=null and habit != ''"><![CDATA[,habit=#{habit}]]></when>
			<otherwise><![CDATA[,habit=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="habitOther!=null and habitOther != ''"><![CDATA[,habit_other=#{habitOther}]]></when>
			<otherwise><![CDATA[,habit_other=NULL ]]></otherwise>
		</choose>
		<choose>
			<when test="relation!=null and relation != ''"><![CDATA[,relation=#{relation}]]></when>
			<otherwise><![CDATA[,relation=NULL ]]></otherwise>
		</choose>
		<if test="idCardNum!=null and idCardNum != ''" >, id_card_num=#{idCardNum}</if>
		<if test="verifyStatus!=null and verifyStatus != ''" >, verify_status=#{verifyStatus}</if>

		WHERE
			user_pin=#{userPin}
		and
			id=#{id}
		AND
			status = 1
	</update>

	<update id="updatePatientForRegister" parameterType="patientInfo">
		UPDATE
			patient_info
		SET
			modified=NOW()
			<if test="patientName!=null" >, patient_name=#{patientName}</if>
			<if test="sex!=null " >, sex=#{sex}</if>
			<if test="phone!=null " >, phone=#{phone}</if>
			<if test="birthday!=null" >, birthday=#{birthday}</if>
			<if test="idCardNum!=null and idCardNum != ''" >, id_card_num=#{idCardNum}</if>
			<if test="verifyStatus!=null and verifyStatus != ''" >, verify_status=#{verifyStatus}</if>
			<if test="patientId!=null and patientId != ''" >, patient_id=#{patientId}</if>
		WHERE
			user_pin=#{userPin}
		and
			id=#{id}
		AND
			status=1
	</update>
	<!--查询患者信息-->
	<select id="getPatientInfo" parameterType="patientInfo" resultType="patientInfo">
		SELECT
			<include refid="QUERY_COLUMN_LIST"/>
		FROM
			patient_info
		WHERE
			user_pin = #{userPin}
	  	AND
			id = #{id}
		AND
			status =1
	</select>
<!--删除患者信息-->
	<delete id="delPatientInfo" parameterType="patientInfo">
		DELETE FROM
		   patient_info
		WHERE
		   user_pin=#{userPin}
		and
			id=#{id}
	</delete>
	<!--<update id="delPatientInfo" parameterType="patientInfo">-->
		<!--UPDATE-->
			<!--patient_info-->
		<!--SET-->
			<!--modified=NOW(),-->
		  	<!--status = 2-->
		<!--WHERE-->
		   <!--user_pin=#{userPin}-->
		<!--and-->
			<!--id=#{id}-->
		<!--AND-->
			<!--status=1-->
	<!--</update>-->

	<!--根据患者id和userpin删除患者信息-->
	<!--<delete id="delPatientInfoByPatientId" parameterType="patientInfo">-->
		<!--DELETE FROM-->
		<!--patient_info-->
		<!--WHERE-->
		<!--user_pin=#{userPin}-->
		<!--and-->
		<!--patient_id=#{patientId}-->
	<!--</delete>-->
	<update id="delPatientInfoByPatientId" parameterType="patientInfo">
		UPDATE
			patient_info
		SET
			modified=NOW(),
		  	status = 2
		WHERE
			user_pin=#{userPin}
		AND
			patient_id=#{patientId}
	</update>


	<select id="getPatientCount" parameterType="patientInfo" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM patient_info WHERE   user_pin=#{userPin} AND status=1
	</select>


	<update id="updateContactLensesInfo" parameterType="patientInfo">
		UPDATE
		patient_info
		SET
		modified=NOW()
		<if test="rightMyopia!=null" >, right_myopia=#{rightMyopia}</if>
		<if test="leftMyopia!=null" >, left_myopia=#{leftMyopia}</if>
		<if test="isAstigmatic!=null" >, is_astigmatic=#{isAstigmatic}</if>
		<if test="rightAstigmatic!=null" >, right_astigmatic=#{rightAstigmatic}</if>
		<if test="leftAstigmatic!=null" >, left_astigmatic=#{leftAstigmatic}</if>
		<if test="rightAxlePosition!=null" >, right_axle_position=#{rightAxlePosition}</if>
		<if test="leftAxlePosition!=null" >, left_axle_position=#{leftAxlePosition}</if>
		WHERE
			user_pin=#{userPin}
		AND
			id=#{id}
		AND
			status=1
	</update>


	<!--查询患者信息-->
	<select id="getPatientSimpleInfo" parameterType="patientInfo" resultType="patientInfo">
		SELECT
		<include refid="QUERY_SIMPLE_COLUMN_LIST"/>
		FROM
			patient_info
		WHERE
		user_pin = #{userPin}
		AND
		id = #{id}
		AND
		status=1
	</select>

	<!--查询患者信息-->
	<select id="getPatientInfoByIdCardNumAndPin" parameterType="patientInfo" resultType="patientInfo">
		SELECT
			<include refid="QUERY_COLUMN_LIST"/>
		FROM
			patient_info
		WHERE
			user_pin = #{userPin}
		AND
			id_card_num = #{idCardNum}
		AND
			status=1
		<if test="id!=null" >AND id !=#{id} </if>
		LIMIT 0,1
	</select>

	<!--查询Pin下患者信息-->
	<select id="getPatientByPatientNameAndPhoneAndUserPin" parameterType="patientInfo" resultType="patientInfo">
		SELECT
		<include refid="QUERY_COLUMN_LIST"/>
		FROM
		patient_info
		WHERE
		user_pin = #{userPin}
		AND
		patient_name = #{patientName}
		AND
		phone = #{phone}
		<if test="id!=null" >AND id !=#{id} </if>

	</select>
</mapper>